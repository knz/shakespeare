role wait_upreplication
  :wait $COCKROACH sql --insecure -p 26257 \\
      -e "select if((select min(array_length(replicas,1)) from crdb_internal.ranges)>=3, 0, if(pg_sleep(.5), crdb_internal.force_retry('1h'), 0))"; sleep 2
end

cast
  waiter plays wait_upreplication
end

script
  action  w entails :wait
  prompt  waiter .w
end
